<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/images/dampe.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="dampestyle.css">
    <title>ClintStevensTV</title>
  <style>
    button {
      padding: 12px 24px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      background-color: #444;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body class="dampebody">
  <h1 style="text-align: center;">Dampe Digging</h1>
  <button id="digBtn" onclick="dig()" class="digBtn">Dig</button>
  <div id="result" class="dampebody"></div>

    <script>
        let currentDrought = 0;
        let longestDrought = 0;
        let heartPiecesReceived = 0;
        let greenRupees = 0;
        let blueRupees = 0;
        let redRupees = 0;
        let digCount = 0;
        let displayedRupees = 99;
        let Rupees = 99;
        let previousRupees = Rupees;


        // Rupee Number Animation
        function animateRupeeCount() {
          if (displayedRupees !== Rupees) {
            // Easing
            displayedRupees += (Rupees - displayedRupees) * 0.1;

            // Snap to final value if very close
            if (Math.abs(Rupees - displayedRupees) < 0.5) {
              displayedRupees = Rupees;
            }

            // Round and update display
            const rounded = Math.round(displayedRupees);
            document.getElementById("rupeeAmount").textContent = rounded;

            // Flash if the value changes
            if (rounded !== previousRupees) {
              const counterEl = document.getElementById("rupeeCounter");

              if (rounded > previousRupees) {
                counterEl.classList.add("flash-gain");
                setTimeout(() => counterEl.classList.remove("flash-gain"), 300);
              } else if (rounded < previousRupees) {
                counterEl.classList.add("flash-loss");
                setTimeout(() => counterEl.classList.remove("flash-loss"), 300);
              }

              previousRupees = rounded;
            }
          }

          requestAnimationFrame(animateRupeeCount);
        }

        // Controller Support
        let gamepadIndex = null;
        let prevButtonsPressed = [];

        window.addEventListener("gamepadconnected", (e) => {
          console.log("Gamepad connected:", e.gamepad);
          gamepadIndex = e.gamepad.index;
          pollGamepad();
        });

        window.addEventListener("gamepaddisconnected", (e) => {
          console.log("Gamepad disconnected:", e.gamepad);
          if (gamepadIndex === e.gamepad.index) {
            gamepadIndex = null;
            prevButtonsPressed = [];
          }
        });

        function pollGamepad() {
          if (gamepadIndex !== null) {
            const gamepad = navigator.getGamepads()[gamepadIndex];
            if (gamepad) {
              gamepad.buttons.forEach((button, index) => {
                const wasPressed = prevButtonsPressed[index] || false;
                if (button.pressed && !wasPressed) {
                  dig();
                }
                prevButtonsPressed[index] = button.pressed;
              });
            }
          }
          requestAnimationFrame(pollGamepad);
        }

        // Button And Mouse Support
        function dig() {

          if (Rupees < 10) {
              const resultDiv = document.getElementById("result");
              resultDiv.innerHTML = `<p>You need at least 10 Rupees to dig!</p>
              <button onclick="resetRun()" class="resetBtn">Reset Run</button>
              <a href="/index.html" class="back-button">Back to ClintStevensTV</a>
              `;

              const counterEl = document.getElementById("rupeeCounter");
              counterEl.classList.add("flash-loss");
              setTimeout(() => counterEl.classList.remove("flash-loss"), 300);

              sendRupeeDataToSheet()

              return; // Exit the function early
          }

            digCount++;  // Increment dig counter each dig
            Rupees -= 10;
            const digBtn = document.getElementById("digBtn");
            digBtn.classList.add("digflash");
            setTimeout(() => digBtn.classList.remove("digflash"), 200);


            const roll = Math.random();
            let resultText = "";
            let imageName = "";

                if (roll < 0.10) {
                    resultText = "Heart Piece";
                    imageName = "heartpiece.png";

                    heartPiecesReceived++; // Increment heart pieces counter
                    document.getElementById("heartCount").textContent = heartPiecesReceived;

                    if (currentDrought > longestDrought) {
                    longestDrought = currentDrought;
                    }
                    currentDrought = 0;
                    Rupees = 99;
                } else if (roll < 0.50) {
                    resultText = "Green Rupee";
                    imageName = "grnrup.png";

                    greenRupees++; // +1 Rupee Counter
                    document.getElementById("greenCount").textContent = greenRupees;

                    Rupees += 1;
                    currentDrought++;
                } else if (roll < 0.80) {
                    resultText = "Blue Rupee";
                    imageName = "blurup.png";

                    blueRupees++; // +1 Rupee Counter
                    document.getElementById("blueCount").textContent = blueRupees;

                    Rupees += 5;
                    currentDrought++;
                } else {
                    resultText = "Red Rupee";
                    imageName = "redrup.png";

                    redRupees++; // +1 Rupee Counter
                    document.getElementById("redCount").textContent = redRupees;

                    Rupees += 20;
                    currentDrought++;
                }

                const resultDiv = document.getElementById("result");

                resultDiv.innerHTML = `
                <p>${resultText}</p>
                <img src="/images/${imageName}" alt="${resultText}" class="result-img" />
                `;

                document.getElementById("digCount").textContent = digCount;

                document.getElementById("currentDrought").textContent = `Current Drought: ${currentDrought}`;
                document.getElementById("longestDrought").textContent = `Longest Drought: ${longestDrought}`;
                document.getElementById("rupeeAmount").textContent = Rupees;
                
        }

        function resetRun() {
            Rupees = 99;
            displayedRupees = 99;
            previousRupees = 99;
            digCount = 0;
            currentDrought = 0;
            longestDrought = 0;
            heartPiecesReceived = 0;
            greenRupees = 0;
            blueRupees = 0;
            redRupees = 0;

            // Clear result area
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = "";

            // Update all stats
            document.getElementById("currentDrought").textContent = `Current Drought: ${currentDrought}`;
            document.getElementById("longestDrought").textContent = `Longest Drought: ${longestDrought}`;
            document.getElementById("rupeeAmount").textContent = Rupees;
            document.getElementById("greenCount").textContent = greenRupees;
            document.getElementById("blueCount").textContent = blueRupees;
            document.getElementById("redCount").textContent = redRupees;
            document.getElementById("heartCount").textContent = heartPiecesReceived;
        }

    animateRupeeCount();

    function sendRupeeDataToSheet() {
      const data = {
        greenRupees,
        blueRupees,
        redRupees,
        heartPiecesReceived,
        digCount,
        key: "St3veClintsD0esit4g41n"
      };

      fetch("https://script.google.com/macros/s/AKfycbxZnybp-16Q_QjYeRxfkfWfqyVQhiNratNjCkwvhsONbf0nDwhcmsjDQL-6YhmRJDjVNg/exec", {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => res.text())
      .then(response => {
        console.log("Logged to Google Sheets:", response);
        alert("Run submitted to Google Sheets!");
      })
      .catch(err => {
        console.error("Failed to log run:", err);
        alert("Error logging run.");
      });
    }
    </script>

  <div id="droughtStats" style="text-align:center; vertical-align: middle; margin-top: 1em;">
    <div id="currentDrought">Current Drought: 0</div>
    <div id="longestDrought">Longest Drought: 0</div><br>
  </div>

    <div id="itemSummary">
      <div><img src="/images/Dampe.png" alt="digCount"><span id="digCount">0</span></div>
      <div><img src="/images/grnrup.png" alt="Green Rupee"><span id="greenCount">0</span></div>
      <div><img src="/images/blurup.png" alt="Blue Rupee"><span id="blueCount">0</span></div>
      <div><img src="/images/redrup.png" alt="Red Rupee"><span id="redCount">0</span></div>
      <div><img src="/images/heartpiece.png" alt="Heart Piece"><span id="heartCount">0</span></div>
    </div>

    <div id="rupeeCounter">
      <img src="/images/wallet.webp" alt="Rupee">
      <span id="rupeeAmount">99</span>
    </div>

</body>
</html>